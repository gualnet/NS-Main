<div class="row" id="navbarRow">
    <nav class="navbar fixed-bottom navbar-light bg-light nav-pills nav-fill">
        <div class="nav-item">
            <a class="navbar-brand" href="/index"><img id="navbar-index" src="/library/toolbar-anchor-48.png" style="height:24px;width:24px;"></a>
        </div>
        <div class="nav-item">
            <a id="harbourmap" class="navbar-brand" href="/map"><img id="navbar-map" src="/library/toolbar-map-48-empty.png" style="height:24px;width:24px;"></a>
        </div>
        <div class="nav-item">
            <a class="navbar-brand" href="/notifications"><img id="navbar-notif" src="/library/toolbar-bell-48.png" style="height:24px;width:24px;"></a>
        </div>
        <div class="nav-item">
            <a class="navbar-brand" href="/profil"><img id="navbar-profil" src="/library/toolbar-profile-48.png" style="height:24px;width:24px;"></a>
        </div>
    </nav>
</div>

<script>
    var url = window.location.href;
    url = url.split('/');
    var currentLocation = url[url.length - 1];
    console.log(currentLocation);
    if (currentLocation == "index")
        document.getElementById('navbar-index').src = "/library/toolbar-anchor-blue-48.png";
    else if (currentLocation == "map")
        document.getElementById('navbar-map').src = "/library/toolbar-map-blue-48.png";
    else if (currentLocation == "notifications")
        document.getElementById('navbar-notif').src = "/library/toolbar-bell-blue-48.png";
    else if (currentLocation == "profil")
        document.getElementById('navbar-profil').src = "/library/toolbar-profile-blue-48.png";
        
    fetch("/api/getharbour/" + localStorage['harbourid']).then(response => response.json()).then(_data => {
        let harbour = _data.data;
        var sBrowser, sUsrAg = navigator.userAgent;
                if (sUsrAg.indexOf("Safari") > -1) {
                    sBrowser = "Apple Safari";
                    document.getElementById("harbourmap").href = 'http://maps.apple.com/?q=' + harbour.address;
                } else {
                    document.getElementById("harbourmap").href = 'geo:0,0?q=' + harbour.address;
                }
    }).catch((e) => console.error(e))

		window.addEventListener('load', async (ev) => {
			const userId = localStorage['user'];
			const userCategory = (!userId) ? 'visitor' : 'yachtsman';
			const harbourId = localStorage['harbourid'];

			const communications = await fetchCommunicationsNavbar(harbourId, userCategory);
			checkIfUnreadCommunications(userId, communications);
		});

		const fetchCommunicationsNavbar = async (harbourId, userCategory) => {
			try {
				const urlCategory = `/api/next/communications?harbour_id=${harbourId}&user_category=${userCategory}`;
				const urlAll = `/api/next/communications?harbour_id=${harbourId}&user_category=all`;

				const promiseCategory = fetch(urlCategory);
				const promiseAll = fetch(urlAll);
				const resp = await Promise.all([promiseCategory, promiseAll]);
				const decodedCategory = await resp[0].json();
				const decodedAll = await resp[1].json();

				const comms = [...decodedCategory, ...decodedAll];
				return (comms);
			} catch (error) {
				console.error(error);
				return ([]);
			}
		};

		const checkIfUnreadCommunications = (userId, comms = []) => {
			for(const com of comms) {
				if (!com.read_id?.includes(userId)) {
					isUnreadComm = true;
					document.getElementById('navbar-notif')
						.src = "/library/notification-active-48.png";
					break;
				}
			}
		}

</script>