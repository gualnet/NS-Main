<div class="row" id="navbarRow">
	<nav class="navbar fixed-bottom navbar-light bg-light nav-pills nav-fill">
			<div class="nav-item">
					<a class="navbar-brand" href="/index" id="navbarIndexLink"><img id="navbar-index" src="/library/toolbar-anchor-48.png" style="height:24px;width:24px;"></a>
			</div>
			<div class="nav-item">
					<a id="harbourmap" class="navbar-brand" href="/map"><img id="navbar-map" src="/library/toolbar-map-48-empty.png" style="height:24px;width:24px;"></a>
			</div>
			<div class="nav-item">
					<a class="navbar-brand" href="/notifications"><img id="navbar-notif" src="/library/toolbar-bell-48.png" style="height:24px;width:24px;"></a>
			</div>
			<div class="nav-item">
					<a class="navbar-brand" href="/profil"><img id="navbar-profil" src="/library/toolbar-profile-48.png" style="height:24px;width:24px;"></a>
			</div>
	</nav>
</div>

<script>
	window.addEventListener('load', async () => {
		initNavbarBrandLink();
		displayBlueIconWhenOnPage();

		const userId = localStorage['user'];
		const userCategory = (!userId) ? 'visitor' : 'yachtsman';
		const harbourId = localStorage['harbour_id'];

		const communications = await fetchCommunicationsNavbar(harbourId, userCategory);
		checkIfUnreadCommunications(userId, communications);
	});

	const initNavbarBrandLink = () => {
		if (localStorage['entity_id'] === 'BgSNKrOB59') {
			const navbarIndexLinkEl = document.querySelector('#navbarIndexLink');
			if (!navbarIndexLinkEl) return;
			navbarIndexLinkEl.href = '/index-corse';
		}
	}

	const displayBlueIconWhenOnPage = () => {
		let url = window.location.href;
		url = url.split('/');
		const currentLocation = url[url.length - 1];
		if (currentLocation == "index" || currentLocation == "index-corse")
				document.getElementById('navbar-index').src = "/library/toolbar-anchor-blue-48.png";
		else if (currentLocation == "map")
				document.getElementById('navbar-map').src = "/library/toolbar-map-blue-48.png";
		else if (window.location.href.includes("notification"))
			document.getElementById('navbar-notif').src = "/library/toolbar-bell-blue-48.png";
		else if (currentLocation == "profil")
			document.getElementById('navbar-profil').src = "/library/toolbar-profile-blue-48.png";
	};

	fetch("/api/getharbour/" + localStorage['harbour_id']).then(response => response.json()).then(data => {
		const harbour = data.data
		const harbourMapEl = document.getElementById("harbourmap");
		if (harbourMapEl) {
			if (harbour.google_map_link) {
				harbourMapEl.href = harbour.google_map_link; // embed external google map
			} else if (harbour.address) {
				let mapLink = `https://www.google.com/maps/?q=${harbour.address}`; // default map link
				if (navigator.userAgent.toLowerCase().indexOf('iphone') !== -1) {
					mapLink = `https://maps.apple.com/?q=${harbour.address}` //
				}
				harbourMapEl.href = mapLink;
			} else {
				const mapPdfEl = document.getElementById("map_pdf");
				if (mapPdfEl) {
					mapPdfEl.hidden = true;
				}
			}
		}
	}).catch((e) => console.error(e))


	const fetchCommunicationsNavbar = async (harbourId, userCategory) => {
		try {
			const url = `/api/next/communications?harbour_id=${harbourId}`;
			const response = await fetch(url);
			const respJson = await response.json();
			const comms = respJson || [];
			return (comms);
		} catch (error) {
			console.error(error);
			return ([]);
		}
	};

	const checkIfUnreadCommunications = (userId, comms = []) => {
		if (window.location.href.includes('notification')) {
			return;
		}

		const navbarNotifEl = document.getElementById('navbar-notif');
		if (!navbarNotifEl) {
			console.error('OOOPS navbarNotifEl not found')
			return;
		}

		const readNotifStr = localStorage['read-notifications'];
		if (!readNotifStr && comms.length > 0) { // if no read notif list but notifications..
			navbarNotifEl.src = "/library/notification-active-48.png";
			return;
		}

		let isUnreadComm = false;
		for (const comm of comms) {
			const commId = comm.id;
			if (!readNotifStr.includes(commId)) {
				isUnreadComm = true;
				break;
			}
		}

		if (isUnreadComm) {
				navbarNotifEl.src = "/library/notification-active-48.png";
		}
	};

</script>