<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

	<title>Offres Plaisenciers Plugin</title>
	<link rel="icon" href="/fortpress_admin_assets/favicon.ico" type="image/x-icon" />

	<!-- Quill Plugin -->
	<link href="/assets/quill/quill.snow.css" rel="stylesheet">
	<script src="/assets/quill/quill.js"></script> <!-- Create the editor container -->

	<script src="/fortpress_admin_assets/assets/js/require.min.js"></script>
	<script>
		requirejs.config({ baseUrl: '/' });
	</script>

	<!-- Dashboard Core -->
	<link href="/fortpress_admin_assets/assets/css/dashboard.css" rel="stylesheet" />
	<script src="/fortpress_admin_assets/assets/js/dashboard.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Datatables Plugin -->
	<script src="/fortpress_admin_assets/assets/plugins/datatables/plugin.js"></script>

</head>

<body>

	<div class="page">
		<div class="flex-fill">
			<div class="my-3 my-md-5">
				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-header">
								<h3 class="card-title">Gestion des offres</h3>
							</div>
							<div class="card-body">
								<div id="harbourError" style="background-color: lightcoral; padding: 10px; display: none; align-items: center;"></div>
								<form method="POST" enctype="multipart/form-data" id="createForm">
									<div class="row">
										<div class="col-12">
											<div class="form-group">
												<label class="form-label">Sélection du port</label>
												<select id="harboursSelect" class="form-control" style="width:250px;" name="harbour_id">
													__HARBOUR_SELECT_OPTIONS__
												</select>
											</div>
										</div>
										<div class="col-lg-12">
											<div class="form-group">
												<label class="form-label">Titre</label>
												<input id="titleInput" class="form-control" name="title" required>
											</div>
										</div>
										<div class="col-lg-6 col-md-6 col-sm-6">
											<div class="form-group">
												<label class="form-label">Date de début</label>
												<input id="startDate" type="date" class="form-control" name="date_start" required>
											</div>
										</div>
										<div class="col-lg-6 col-md-6 col-sm-6">
											<div class="form-group">
												<label class="form-label">Date de fin</label>
												<input id="endDate" type="date" class="form-control" name="date_end" required>
											</div>
										</div>
										<div class="col-lg-12">
											<div class="form-group">
												<label class="form-label">image</label>
												<input id="img" type="file" class="form-control" accept="image/png, image/jpg" name="img">
											</div>
										</div>
										<div class="col-lg-12">
											<div class="form-group">
												<label class="form-label">Nom de la pièce Jointe</label>
												<input type="text" class="form-control" name="pjName">
											</div>
										</div>
										<div class="col-lg-12">
											<div class="form-group">
												<label class="form-label">Pièce Jointe</label>
												<input class="form-control" type="file" name="pj">
											</div>
										</div>
										<div class="col-lg-12 mb-6">
											<div class="form-group">
												<label class="form-label">Description(240 caractères)</label>
												<div id="description">
												</div>
											</div>
										</div>
										<div class="col-lg-12 mt-7 mb-7">
											<div class="form-group">
												<label class="form-label">Contenu</label>
												<div id="editor">
												</div>
											</div>
										</div>
										<div class="col-lg-1">
											<div class="form-group">
												<button type="button" style="margin-top:27px" class="btn btn-primary"
													onclick="sendCreateForm();"> <i class="fe fe-plus"></i></button>
											</div>
										</div>
									</div>
								</form>

								<div class="table-responsive">
									<table class="table card-table table-vcenter text-nowrap datatable dataTable">
										<thead>
											<tr>
												<th>ID</th>
												<th>Nom du port</th>
												<th>Titre</th>
												<th>Date de début</th>
												<th>Date de fin</th>
												<th>Description</th>
												<th>Contenu</th>
												<th>Nom de la pièce jointe</th>
												<th>Pièce jointe</th>
												<th>Remplacer pièce jointe</th>
												<th>Image</th>
												<th>Remplacer image</th>
												<th>Date de création</th>
												<th></th>
											</tr>
											<thead>
											<tbody id="result">
												<!-- __OFFERS__ -->
											</tbody>
									</table>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let G_Table;
		let G_SelectedHarbourId = '__SELECTED_HARBOUR_ID__';

		window.addEventListener('load', async () => {
			await initDatatable();
			initQuill();

			const offers = await getofferByHarbour(G_SelectedHarbourId);
			const rows = createOfferRows(offers, G_SelectedHarbourId);
			displayOffers(rows);

			const harboursSelectEl = document.querySelector('#harboursSelect');
			harboursSelectEl.addEventListener('change', selectHarbourChangeHandler);
		});


		const initDatatable = async () => {
			return(new Promise((resolve, reject) => {
				require(['datatables', 'jquery'], function (datatable, $) {
					G_Table = $('.datatable').DataTable({
						language: {
							search: '<span></span>',
							searchPlaceholder: 'Votre recherche'
						},
						paging: false,
						"order": [[9, "desc"]], // Date de création
						"info": false,
					});
					resolve();
				});
			}))
		}

		const initQuill = () => {
			const quill = new Quill('#editor', {
				placeholder: 'Entrez le texte...',
				theme: 'snow'
			});
			const quillDescription = new Quill('#description', {
				placeholder: 'Entrez le texte...',
				theme: 'snow'
			});
		};

		const reinitQuillAfterUpdate = () => {
			const descriptors = document.querySelectorAll('.row-description');
			for (item of descriptors) {
				const itemId = item.id;
				new Quill(`#${itemId}`, {
					placeholder: 'Entrez le texte...',
					theme: 'snow'
				});
			}
		};

		const cleanCreateFormFields = () => {
			const titleInputEl = document.querySelector('#titleInput');
			titleInputEl.value = null;
			const startDateEl = document.querySelector('#startDate');
			startDateEl.value = null;
			const endDateEl = document.querySelector('#endDate');
			endDateEl.value = null;
			const imgEl = document.querySelector('#img');
			imgEl.value = null;
			const descriptionEl = document.querySelector('#description');
			descriptionEl.firstChild.classList.add('ql-blank');
			descriptionEl.firstChild.innerHTML = '<p><br></p>';
			const contentEl = document.querySelector('#editor');
			contentEl.firstChild.classList.add('ql-blank');
			contentEl.firstChild.innerHTML = '<p><br></p>';
		};
		const selectHarbourChangeHandler = async (ev) => {
			try {
				const selectedHarbourId = ev.target.value;
				G_SelectedHarbourId = selectedHarbourId;

				const offers = await getofferByHarbour(selectedHarbourId);
				const rows = createOfferRows(offers, selectedHarbourId);
				displayOffers(rows);
				cleanCreateFormFields();
			} catch (error) {
				console.error('Error', error);
			}
		};

		const getofferByHarbour = async (harbourId = G_SelectedHarbourId) => {
			const response = await fetch(`/api/offers/harbour/${harbourId}`);
			const jsonResp = await response.json();
			const offers = jsonResp.offers;
			return(offers);
		}

		const displayOffers = (offerRows) => {
			G_Table.destroy();
			document.querySelector('#result').innerHTML = offerRows;
			initDatatable();
			reinitQuillAfterUpdate();
		}

		const createOfferRows = (offers = [], harbourId = G_SelectedHarbourId) => {
			const harbourOptionEl = document.getElementById(`opt_${harbourId}`);
			const harbourName = harbourOptionEl?.innerHTML || '';

			let rows = '';
			offers.map(offer => {
				rows += `
				<tr>
					<form method="POST" enctype="multipart/form-data" id="form_${offer.id}">
						<td><input name="id" type="hidden" value="${offer.id}">${offer.id}</td>
						<td><input name="harbour_id" type="hidden" value="${offer.harbour_id}">${harbourName}</td>
						<td><textarea id="title_${offer.id}" name="title">${offer.title}</textarea></td>
						<td><input id="row_date_start_${offer.id}" name="date_start" type="date" value="${offer.date_start}" /></td>
						<td><input id="row_date_end_${offer.id}" name="date_end " type="date" value="${offer.date_end}" /></td>
						<td>
							<div class="row-description" id="row_desc_${offer.id}" style="width:400px;height:100px;">${offer.description}</div>
						</td>
						<td>
							<div class="row-description" id="row_content_${offer.id}" style="width:400px;height:100px;">${offer.content}</div>
						</td>
						<td><input id="row_pj_name_${offer.id}" name="pjname" value="${offer.pjName || ''}"></td>
						<td><a target="_blank" href="${offer.pj}">${offer.pj}</a></td>
						<td><input id="row_pj_${offer.id}" type="file" class="form-control" name="pj"></td>
						<td><a target="_blank" href="${offer.img}">${offer.img}</a></td>
						<td><input id="row_img_${offer.id}" type="file" accept="image/png, image/jpg" class="form-control" accept="image/png, image/jpg" name="img"></td>
						<td>${offer.updated_at || offer.created_at}</td>
						<td>
								<a href="#" onclick="sendDeleteRequest('${offer.id}')"> <i class="fe fe-trash"></i></a>
								<button type="button" class="btn" onclick="sendUpdateForm('${offer.id}');"> <i class="fa fa-save"></i></button>
						</td>
					</form>
				</tr>
			`;
			});
			return (rows);
		}

		const sendCreateForm = async () => {
			if (!G_SelectedHarbourId) {
				alert('Pas de port sélectionné !');
				return;
			}

			const form = document.getElementById("createForm");
			const formData = new FormData(form);

			const descriptionEl = form.querySelector(`#description`);
			const descriptionText = descriptionEl.firstChild.innerHTML;
			formData.append("description", descriptionText);
			
			const contentEl = form.querySelector(`#editor`);
			const contentText = contentEl.firstChild.innerHTML;
			formData.append("content", contentText);

			try {
				const resp = await fetch('/api/offers', {
					method: 'POST',
					body: formData,
					headers: new Headers({ "Authorization": `Bearer ${localStorage['token']}` }),
				});
				const respJson = await resp.json();
				if (respJson.success === false) {
					console.error('error', respJson);
					const errCtnEl = document.querySelector('#harbourError');
					errCtnEl.style.display = 'flex';
					errCtnEl.textContent = respJson.error;
					alert(`Erreur: ${respJson.error}`);
					setTimeout(() => {
						errCtnEl.style.display = 'none';
					}, 2000);
					return;
				}

				const offers = await getofferByHarbour()
				const rows = createOfferRows(offers)
				displayOffers(rows)
				cleanCreateFormFields();
			} catch (error) {
				console.error('error')
				alert('ERROR !')
			}
		};

		const sendUpdateForm = async (id) => {
			try {
				const form = document.querySelector(`#form_${id}`);

				const formData = new FormData(form);
				formData.append("title", document.querySelector(`#title_${id}`).value);

				const descriptionEl = document.getElementById(`row_desc_${id}`);
				const descriptionText = descriptionEl.firstChild.firstChild.innerHTML;
				formData.append("description", descriptionText);
				
				const contentEl = document.getElementById(`row_content_${id}`);
				const contentText = contentEl.firstChild.firstChild.innerHTML;
				formData.append("content", contentText);

				formData.append("date_start", document.querySelector(`#row_date_start_${id}`).value);
				formData.append("date_end", document.querySelector(`#row_date_end_${id}`).value);

				const imgEl = document.querySelector(`#row_img_${id}`);
				const imgFileBlob = imgEl.files[0];
				if (imgFileBlob) {
					formData.append("img", imgFileBlob);
				}

				const pjEl = document.querySelector(`#row_pj_${id}`);
				const pjfileBlob = pjEl.files[0];
				if (pjfileBlob) {
					formData.append("pj", pjfileBlob);
				}

				const pjNameEl = document.querySelector(`#row_pj_name_${id}`);
				const pjName = pjNameEl.value || pjfileBlob?.name || 'unknown.file';
				formData.append("pjName", pjName);

				const url = `/api/offers/${id}`;
				const resp = await fetch(url, {
          method: 'PUT',
					body: formData,
					headers: new Headers({ "Authorization": `Bearer ${localStorage['token']}` }),
				});
				const respJson = await resp.json();
				if (respJson.success === false) {
					console.error('error', respJson);
					const errCtnEl = document.querySelector('#harbourError');
					errCtnEl.style.display = 'flex';
					errCtnEl.textContent = respJson.error;
					alert(`Erreur: ${respJson.error}`);
					setTimeout(() => {
						errCtnEl.style.display = 'none';
					}, 2000);
					return;
				}
				const offers = await getofferByHarbour();
				const rows = createOfferRows(offers);
				displayOffers(rows);
			} catch (error) {
				console.error('error', error);
				alert('Erreur !')
			}
		};

		const sendDeleteRequest = async (id) => {
			try {
				const resp = await fetch(`/api/offers/${id}`, { method: 'DELETE' });
				const respJson = await resp.json();

				const offers = await getofferByHarbour();
				const rows = createOfferRows(offers);
				displayOffers(rows)
			} catch (error) {
				console.error('error')
				alert('ERROR !')
			}
		}

	</script>
</body>