<!doctype html>
<html lang="en" dir="ltr">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta http-equiv="Content-Language" content="en" />
	<meta name="msapplication-TileColor" content="#2d89ef">
	<meta name="theme-color" content="#4188c9">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<link rel="icon" href="/fortpress_admin_assets/favicon.ico" type="image/x-icon" />
	<link rel="shortcut icon" type="image/x-icon" href="/fortpress_admin_assets/favicon.ico" />
	<!-- <link href="/assets/quill/quill.snow.css" rel="stylesheet"> -->
	<!-- <script src="/assets/quill/quill.js"></script> Create the editor container -->

	<title>Vendors management</title>
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> -->
	<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,500,500i,600,600i,700,700i&amp;subset=latin-ext"> -->
	<script src="/fortpress_admin_assets/assets/js/require.min.js"></script>
	<script>
		requirejs.config({
			baseUrl: '/'
		});
	</script>
	<!-- Dashboard Core -->
	<link href="/fortpress_admin_assets/assets/css/dashboard.css" rel="stylesheet" />
	<script src="/fortpress_admin_assets/assets/js/dashboard.js"></script>
	<!-- c3.js Charts Plugin -->
	<!-- <link href="/fortpress_admin_assets/assets/plugins/charts-c3/plugin.css" rel="stylesheet" /> -->
	<!-- <script src="/fortpress_admin_assets/assets/plugins/charts-c3/plugin.js"></script> -->
	<!-- Input Mask Plugin -->
	<!-- <script src="/fortpress_admin_assets/assets/plugins/input-mask/plugin.js"></script> -->
	<!-- Datatables Plugin -->
	<!-- <script src="/fortpress_admin_assets/assets/plugins/datatables/plugin.js"></script> -->
</head>

<body class="">
	<div class="page">
		<div class="flex-fill">
			<div class="my-3 my-md-5">
				<div class="row">
					<div class="col-lg-12">
						<div class="card">
							<div class="card-header">
								<h3 class="card-title">Gestion des sorties</h3>
							</div>
							<div class="card-body">
								<div id="harbourError"></div>
								<!-- <div class="row">
									__HARBOUR_ID_INPUT__
								</div> -->
								<div class="table-responsive">
									<table class="table card-table table-vcenter text-nowrap datatable dataTable">
										<thead>
											<tr>
												<th>Bateau</th>
												<th>Place</th>
												<th>Plaisancier</th>
												<th>Position</th>
												<th>Nombre d'absences</th>
												<th>Nombre de sorties</th>
												<th>Challenge</th>
											</tr>
										</thead>
										<tbody id="sortieRowsCtn">
										</tbody>
									</table>
									<nav aria-label="Page navigation example">
										<ul class="pagination">
											<li class="page-item" id="paginationBtnPrev">
												<a class="page-link" href="#" aria-label="Previous">
													<span aria-hidden="true">&laquo;</span>
												</a>
											</li>
											<li class="page-item"><a class="page-link" id="paginationBtnA" href="#">1</a></li>
											<li class="page-item"><a class="page-link" id="paginationBtnB" href="#">2</a></li>
											<li class="page-item"><a class="page-link" id="paginationBtnC" href="#">3</a></li>
											<li class="page-item" id="paginationBtnNext">
												<a class="page-link" href="#" aria-label="Next">
													<span aria-hidden="true">&raquo;</span>
												</a>
											</li>
										</ul>
									</nav>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		/**
		 * @typedef T_sortie_owner
		 * @property {number} id
		 * @property {string} firstName
		 * @property {string} lastName
		 */
		/**
		 * @typedef T_sortie
		 * @property {string} position
		 * @property {number} countOutings
		 * @property {number} countOutingsHighSeason
		 * @property {number} countOutingsLowSeason
		 * @property {number} countOutingsOffSeason
		 * @property {object} place
		 * @property {number} place.id
		 * @property {string} place.code
		 * @property {object} boat
		 * @property {number} boat.id
		 * @property {string} boat.name
		 * @property {string} boat.boatType
		 * @property {number} boat.draught
		 * @property {number} boat.length
		 * @property {number} boat.width
		 * @property {string} boat.immatriculation
		 * @property {string} boat.synoxDeviceId
		 * @property {Array<T_sortie_owner>} boat.owners
		 * @property {object} harbour
		 * @property {number} harbour.id
		 * @property {number} countCavalaireChallenge
		 */
		/**@type {Array<T_sortie>} */
		let G_sorties;
		/**
		 * @typedef G_buttons
		 * @property {object} pagination
		 * @property {HTMLLinkElement} pagination.prev
		 * @property {HTMLLinkElement} pagination.A
		 * @property {HTMLLinkElement} pagination.B
		 * @property {HTMLLinkElement} pagination.C
		 * @property {HTMLLinkElement} pagination.next
		 */
		/**@type {G_buttons} */
		let G_buttons = {
			pagination: {
				prev: null,
				A: null,
				B: null,
				C: null,
				next: null,
			}
		}
		let G_currentPagination, G_maxPagination, G_rowsByPage;

		window.addEventListener('load', async () => {
			G_sorties = await fetchSorties();
			paginationInitialise();
			sortSortiesBy('userName');
			displayRows();

		});

		const paginationInitialise = () => {
			G_buttons.pagination.prev = document.querySelector('#paginationBtnPrev');
			G_buttons.pagination.A = document.querySelector('#paginationBtnA');
			G_buttons.pagination.B = document.querySelector('#paginationBtnB');
			G_buttons.pagination.C = document.querySelector('#paginationBtnC');
			G_buttons.pagination.next = document.querySelector('#paginationBtnNext');

			G_buttons.pagination.prev.addEventListener('click', paginationPrevClickHandler);
			G_buttons.pagination.next.addEventListener('click', paginationNextClickHandler);

			G_buttons.pagination.A.parentElement.classList.add('active');
			G_currentPagination = 1;
			G_rowsByPage = 10;
			G_maxPagination = Math.trunc(G_sorties.length / G_rowsByPage) + 1;
		};

		const paginationPrevClickHandler = () => {
			console.log('====paginationPrevClickHandler====');
			if (G_currentPagination === 1) return;
			G_currentPagination -= 1;
			updatePaginationButtons();
			displayRows();
		};

		const paginationNextClickHandler = () => {
			console.log('====paginationNextClickHandler====');
			if (G_currentPagination === G_maxPagination) return;
			G_currentPagination += 1;
			updatePaginationButtons();
			displayRows();
		};

		const updatePaginationButtons = () => {
			if (G_currentPagination === 1) {
				G_buttons.pagination.A.innerText = G_currentPagination;
				G_buttons.pagination.B.innerText = G_currentPagination + 1;
				G_buttons.pagination.C.innerText = G_currentPagination + 2;
				G_buttons.pagination.A.parentElement.classList.add('active');
				G_buttons.pagination.B.parentElement.classList.remove('active');
				G_buttons.pagination.C.parentElement.classList.remove('active');
			} else if (G_currentPagination > 1 && G_currentPagination < G_maxPagination) {
				G_buttons.pagination.A.innerText = G_currentPagination - 1;
				G_buttons.pagination.B.innerText = G_currentPagination;
				G_buttons.pagination.C.innerText = G_currentPagination + 1;
				G_buttons.pagination.A.parentElement.classList.remove('active');
				G_buttons.pagination.B.parentElement.classList.add('active');
				G_buttons.pagination.C.parentElement.classList.remove('active');
			} else if (G_currentPagination === G_maxPagination) {
				G_buttons.pagination.A.innerText = G_currentPagination - 2;
				G_buttons.pagination.B.innerText = G_currentPagination - 1;
				G_buttons.pagination.C.innerText = G_currentPagination;
				G_buttons.pagination.A.parentElement.classList.remove('active');
				G_buttons.pagination.B.parentElement.classList.remove('active');
				G_buttons.pagination.C.parentElement.classList.add('active');
			}
		}

		const fetchSorties = async () => {
			try {
				const url = '/api/ias/sorties';
				const response = await fetch(url, { method: 'GET' });
				const { sorties } = await response.json();
				return(sorties);
			} catch (error) {
				console.error('[ERROR]', error);
			}
		};

		/**
		 * @param {string} sortField
		 * @param {bool} isReversed
		 */
		const sortSortiesBy = (sortField, isReversed = false) => {
			const allowedSortFields = ['boatName', 'boatPlace', 'userName'];
			if (!allowedSortFields.includes(sortField)) {
				alert(`Sort Field ${sortField} not authorized.`); //! DEV
				console.warn(`Sort Field ${sortField} not authorized.`);
				return;
			}

			const sorties = G_sorties;
			if (sortField === 'boatName') {
				sorties.sort((itemA, itemB) => (itemA.boat.name < itemB.boat.name) ? -1 : 1);
			} else if (sortField === 'boatPlace') {
				sorties.sort((itemA, itemB) => (itemA.place.code < itemB.place.code) ? -1 : 1);
			} else if (sortField === 'userName') {
				sorties.sort((itemA, itemB) => (itemA.boat.owners[0]?.lastName < itemB.boat.owners[0]?.lastName) ? -1 : 1);
			}

			if (isReversed) {
				sorties.reverse();
			}
		}

		const createRow = (sortie) => {
			let ownerNames = [];
			sortie.boat.owners.map(owner => {
				ownerNames.push(`${owner.lastName} ${owner.firstName}`);
			});
			const row = `
				<tr>
					<form method="POST" enctype="multipart/form-data" id="__FORMID__">
						<td>${sortie.boat?.name ?? 'INCONNU'}</td>
						<td>${sortie.place?.code ?? 'INCONNU'}</td>
						<td>${ownerNames?.join('<br>') || 'INCONNU'}</td>
						<td>${sortie.position ?? 'INCONNU'}</td>
						<td>${sortie.countOutings ?? 'INCONNU'}</td>
						<td>${sortie.countCavalaireChallenge ?? 'INCONNU'}</td>
						<td>${sortie.countOutings ?? 'INCONNU'}</td>
						<td></td>
					</form>
				</tr>
			`;
			return(row);
		};

		const displayRows = () => {
			console.log('====displayRows====')
			const sorties = G_sorties;
			const pagination = G_currentPagination;
			const maxRows = G_rowsByPage || 10;

			const htmlRows = [];
			for (let i = 1; i <= maxRows; i++) {
				const index = (i * pagination) - 1;
				const row = createRow(sorties[index]);
				htmlRows.push(row);
			}
			const sortieRowsCtnEl = document.querySelector('#sortieRowsCtn');
			sortieRowsCtnEl.innerHTML = '';
			sortieRowsCtnEl.innerHTML = htmlRows.join('');
		}
	</script>
</body>

</html>