<!doctype html>
<html lang="fr">

<head>
	<meta charset="utf-8">
	<title>Challenges</title>
	<!-- CSS only -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
	<!-- JavaScript Bundle with Popper -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
		crossorigin="anonymous"></script>

		<link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
</head>

<nav class="navbar navbar-light fixed-top mt-1" style="padding: 2rem;">
	<a id="return_link" class="navbar-brand" href="/index"><i style="font-size:60px;" class="bi bi-arrow-left-circle-fill"></i></a>
</nav>
<body>
	
	<div class="main-ctn">
		<div class="top-ctn">
			<div class="top-ctn__hero">
				<!-- <img src="" alt="trophee image" /> -->
				<h1>Challenge des Sorties</h1>
			</div>
			<div class="top-ctn__helpers">
				<div class="button">Besoin d'aide ?</div>
				<div class="button">Lire les règles</div>
			</div>
		</div>
		<div class="middle-ctn">
			<div class="title-ctn">
				<div class="separator"></div>
				<div class="title">Progression</div>
				<div class="separator"></div>
			</div>
			<div class="score-ctn">
				<div id="score-number">-</div>
				<div>/</div>
				<div>15</div>
				<div>SORTIES</div>
			</div>
			<div class="progression-bar-ctn">
				<div class="progression-bar__progress">
				</div>
			</div>
		</div>
		<div class="bottom-ctn">
			<div class="title-ctn">
				<div class="separator"></div>
				<div class="ctn-title">Détail</div>
				<div class="separator"></div>
			</div>

			<div class="detail-rows-ctn">
			</div>
		</div>
	</div>
	<div class="navbar-ctn">
		<div class="container py-3">
			{{element->navbar.html}}
		</div>
	</div>
</body>
<style>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	@font-face {
		font-family: 'Poppins Regular';
		font-style: normal;
		font-weight: normal;
		src: local('Poppins Regular'), url('/library/Poppins-Regular.woff') format('woff');
	}

	body {
		display: flex;
		margin: 0 auto;
		min-height: 100vh;
	}

	.main-ctn {
		display: grid;
		grid-template-columns: 100vw;
		grid-template-rows: 30vh 30vh 30vh;
	}

	.separator {
		height: 0px;
		border-top: 1px solid black;
		flex-grow: 1;
		margin: 0 40px;
	}
	.title-ctn {
		display: flex;
		font-size: 28pt;
		font-weight: 500;
		align-items: center;
	}

	/* TOP CTN */
	.top-ctn {
		display: flex;
		flex-direction: column;
	}

	.top-ctn__hero {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		height: calc(100% - 60px);
	}
	.top-ctn__hero h1 {
		font-size: 40pt;
	}
	.top-ctn__helpers {
		padding: 0 20px;
		display: flex;
		justify-content: space-between;
		background-color: #1a83f9;
		height: 60px;
		line-height: 60px;
		color: white;
	}
	.top-ctn__helpers .button {
		padding: 0 20px;
	}
	.top-ctn__helpers .button:first-of-type {
		font-size: 28pt;
		font-weight: bolder;
	}
	.top-ctn__helpers .button:nth-of-type(2) {
		font-size: 24pt;
		font-weight: 100;
	}

	/* MID CTN */
	.middle-ctn {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding-top: 30px;
	}
	.middle-ctn .score-ctn {
		margin-top: 5%;
		display: flex;
		justify-content: center;
	}
	.middle-ctn .score-ctn div:nth-of-type(1) {
		color: #1a83f9;
		display: flex;
		flex-direction: column;
    justify-content: flex-end;
    line-height: 100pt;
		font-size: 100pt;
		font-weight: bold;
	}
	.middle-ctn .score-ctn div:nth-of-type(2) {
		display: flex;
		font-size: 60pt;
		margin: 0 20px;
    align-items: flex-end;
    line-height: 60pt;
	}
	.middle-ctn .score-ctn div:nth-of-type(3) {
		display: flex;
		font-size: 60pt;
    align-items: flex-end;
    line-height: 60pt;
	}
	.middle-ctn .score-ctn div:nth-of-type(4) {
		margin-left: 20px;
		display: flex;
		font-size: 30pt;
    align-items: flex-end;
    line-height: 40pt;
	}
	.middle-ctn .progression-bar-ctn {
		background-color: #acb1b6;
		border-radius: 50px;
		display: flex;
		height: 50px;
		margin-top: 80px;
		width: 80%;
	}
	.middle-ctn .progression-bar__progress {
		display: flex;
		height: 50px;
		border-radius: 50px;
		width: 0%;
		background: linear-gradient(to right, rgb(26,131,249), rgb(30,199,206));
	}

	/* BOT CTN */
	.bottom-ctn {
		display: flex;
		flex-direction: column;
	}
	.bottom-ctn .detail-rows-ctn {
		padding: 20px 40px;
		font-size: 28pt;
		overflow-y: scroll;
	}
	.bottom-ctn .detail-row {
		align-items: center;
		border-radius: 16px;
		box-shadow: 5px 5px 5px rgba(0, 0, 0, .1);
		display: flex;
		height: 80px;
		justify-content: center;
		line-height: 80px;
		margin-bottom: 16px;
	}
	.detail-row__index {
		font-weight: 700;
    width: 15%;
    display: flex;
    justify-content: flex-end;
	}
	.detail-row__date {
		font-size: 30pt;
    font-weight: 500;
    display: flex;
    flex-grow: 1;
    justify-content: center;
	}

	.navbar-ctn {
		display: flex;
		position: absolute;
	}
	.nav-item img {
		height: 70px !important;
		width: 70px !important;
	}

</style>

<script>
	window.addEventListener('load', async () => {
		const sorties = await fetchChallengesByUser() || [];
		displaySorties(sorties);
		updateProgressBar(sorties);
	});

	const fetchChallengesByUser = async () => {
		try {
			const userId = localStorage['user'];
			let url = `/api/ias/challenges/user/?userid=${userId}`;
			const resp = await fetch(url, { method: 'GET' });
			const { sorties } = await resp.json()
			return(sorties);
		} catch (error) {
			console.log(error);
			alert('error');
		}
	};

	const sortiesDateFormatConverter = (timestamp = 0) => {
		const startDate = new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'short' });
		const dateArr = startDate.split('/');
		const formatedDate = `${dateArr[0]}/${dateArr[1]}`;

		const startHour = new Date(timestamp).toLocaleTimeString();
		const hourArr = startHour.split(':');
		const formatedHour = `${hourArr[0]}:${hourArr[1]}`;
		
		const fullFormatedDate = `${formatedDate} à ${formatedHour}`;
		return(fullFormatedDate)
	}

	// take an absence array
	// create the equivalent rows to display the needed data
	// put the rows in the page
	const displaySorties = (sorties = []) => {
		const absencesElements = [];
		let rowCounter = 0;
		for (let i = 0; i < sorties.length; i += 2) {
			rowCounter++;
			const sortieIn = sorties[i];
			const sortieOut = sorties[i + 1];

			const endDate = sortiesDateFormatConverter(sortieIn.datetime);
			const startDate = sortiesDateFormatConverter(sortieOut.datetime);
			absencesElements.push(`
				<div class="detail-row">
					<div class="detail-row__index">${rowCounter}.</div>
					<div class="detail-row__date">${startDate} - ${endDate}	</div>
				</div>
			`);
		}
		const rowsCtn = document.querySelector('.detail-rows-ctn');
		rowsCtn.innerHTML = absencesElements.join('');
	}

	// update the value displayed according to the absences data
	const updateProgressBar = (sorties = []) => {
		const MAX = 15;
		const RATIO = 100 / 15;
		const count = sorties.length / 2;

		const scoreNumberEl = document.querySelector('#score-number');
		scoreNumberEl.innerHTML = count;

		const progress = Math.round(count * RATIO);
		const progressEl = document.querySelector('.progression-bar__progress');
		progressEl.style.width = `${progress}%`;
	}
</script>

</html>