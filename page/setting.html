<!doctype html>
<html lang="en" class="h-100">


{{element->header_app.html}}

<body class="d-flex flex-column h-100 menu-overlay">
	<nav class="navbar navbar-light fixed-top mt-3">
		<a id="return_link" class="navbar-brand" href="/index"><i style="font-size:30px;"
				class="bi bi-arrow-left-circle-fill"></i></a>
	</nav>
	<!-- screen loader -->
	{{element->loader.html}}
	<!-- Begin page content -->
	<main class="flex-shrink-0">
		<!-- Fixed navbar -->
		<header class="header">
			<div class="row">
				<div class="col-auto px-0">
				</div>
				<div class="text-left col align-self-center">
					<h5>Profil</h5>
				</div>
				<div class="ml-auto col-auto align-self-center">

				</div>
			</div>
		</header>

		<!-- page content start -->


		<div class="container mt-4" id="profil_setting">
			<h6>Bateau</h6>
			<form id="boat_form" method="post" autocomplete="off">
				<div class="card mt-3 mb-4">
					<div class="card-body">
						<div class="form-group floating-form-group">
							<div class="form-group floating-form-group">
								<label class="text-muted" for="category-select">Ponton</label>
								<select name="ponton_id" class="form-control" id="ponton-select">
								</select>
							</div>
							<div class="form-group floating-form-group">
								<label class="text-muted" for="category-select">Numéro de place</label>
								<select name="place_id" class="form-control" id="place-select">
								</select>
							</div>
						</div>
						<div class="form-group floating-form-group active">
							<input id="name" name="name" type="text" class="form-control floating-input" required>
							<label class="floating-label">Nom du bateau</label>
						</div>
						<div class="form-group floating-form-group active">
							<input id="immatriculation" name="immatriculation" type="text" class="form-control floating-input"
								required>
							<label class="floating-label">Immatriculation</label>
						</div>
						<div class="form-group floating-form-group active">
							<input id="longueur" name="longueur" type="number" class="form-control floating-input" required>
							<label class="floating-label">Longueur (en m)</label>
						</div>
						<div class="form-group floating-form-group active">
							<input id="largeur" name="largeur" type="number" class="form-control floating-input" required>
							<label class="floating-label">Largeur (en m)</label>
						</div>
						<div class="form-group floating-form-group active">
							<input id="tirant_eau" name="tirant_eau" type="number" class="form-control floating-input" required>
							<label class="floating-label">Tirant d'eau (en m)</label>
						</div>
						<input name="id" id="boat_id" type="text" class="form-control floating-input" required hidden>
						<div id="updateBoatError"> </div>
						<button type="button" class="btn btn-block btn-info btn-lg" onclick="sendBoatForm();">enregistrer</button>
						<button id="delboatbutton" type="button" class="btn btn-block btn-danger btn-lg"
							onclick="deleteBoatForm();">supprimer</button>
					</div>
				</div>
			</form>

			<button id="add_boat_button" type="button" class="btn btn-block btn-info btn-lg mb-4"
				onclick="activateBoatForm();" hidden>ajouter un bateau</button>

			<h6>Informations utilisateur</h6>
			<form id="profil_form" method="post" autocomplete="off">
				<div class="card mt-3 mb-4" id="account_info">
					<div class="card-body">
						<div class="row">
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group active">
									<input id="first_name" name="first_name" type="text" class="form-control floating-input" value="">
									<label class="floating-label">Prénom</label>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group active">
									<input id="last_name" name="last_name" type="text" class="form-control floating-input" value="">
									<label class="floating-label">Nom</label>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group active">
									<input id="email" name="email" type="email" class="form-control floating-input" value=""
										autocomplete="off">
									<label class="floating-label">Email</label>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-12 col-md-6">
								<div class="row">
									<div class="col-3">
										<div class="form-group floating-form-group active">
											<input id="prefix" name="prefix" type="text" class="form-control floating-input" value=""
												required>
											<label class="floating-label">Préfixe</label>
										</div>
									</div>
									<div class="col-9">
										<div class="form-group floating-form-group active">
											<input id="phone" name="phone" type="tel" class="form-control floating-input" value="" required>
											<label class="floating-label">Téléphone mobile</label>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- <h6>Preferences</h6>
                <div class="card mt-3 mb-4" id="preferences-container">
                    <div class="card-body px-0">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item border-color">
                                <div class="row">
                                    <div class="col-auto pr-0 align-self-center text-right">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="customSwitch1" checked="">
                                            <label class="custom-control-label" for="customSwitch1"></label>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="text-dark mb-1">Notifications email</h6>
                                        <p class="text-secondary mb-0 small">Recevoir les notifications par Email</p>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item border-color">
                                <div class="row">
                                    <div class="col-auto pr-0 align-self-center text-right">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="customSwitch4" checked="">
                                            <label class="custom-control-label" for="customSwitch4"></label>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h6 class="text-dark mb-1">Notifications SMS</h6>
                                        <p class="text-secondary mb-0 small">Recevoir les notifications par sms</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div> -->

				<h6 class="mt-3">Changer mot de passe</h6>
				<div class="card mt-3 mb-4" id="change-pwd-container">
					<div class="card-body">
						<div class="row ">
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group">
									<input id="current_password" name="current_password" type="password"
										class="form-control floating-input" value="">
									<label class="floating-label">Mot de passe actuel</label>
								</div>
							</div>
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group">
									<input id="password" name="password" type="password" class="form-control floating-input" value="">
									<label class="floating-label">Nouveau mot de passe</label>
								</div>
							</div>
							<div class="col-12 col-md-6">
								<div class="form-group floating-form-group mb-0">
									<input id="password_confirm" name="password_confirm" type="password"
										class="form-control floating-input" value="">
									<label class="floating-label">Confirmer nouveau mot de passe</label>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="updateError"> </div>
				<button type="button" class="btn btn-block btn-info btn-lg" id="submit-btn"
					onclick="sendForm();">valider</button>
			</form>
			<button id="validate_button" type="button" class="btn btn-block btn-danger btn-lg"
				onclick="disconnect();">Déconnexion</button>
			<div id="AccountDeletionCtn">
				<div></div>
				<button id="deleteBtn" type="button" class="btn btn-block btn-lg" onclick="displayAccountDeletionModal();">Supprimer mon
					compte</button>
			</div>

		</div>
		<br />
		<br />
		<div class="container py-3">
			{{element->navbar.html}}
		</div>
	</main>

	<!-- Modal Delete Account -->
	<div class="myModal hide" id="deleteAccountModal">
		<div class="cardModal">
			<div id="modal-text">
				En cliquant sur le bouton 'Supprimer', votre compte sera supprimé de façon définitive de nos serveurs.
			</div>
			<div id="modal-btn-ctn">
				<div id="cancelBtn" onclick="hideAccountDeletionModal()">Annuler</div>
				<div id="delBtn" onclick="deleteMyAccount()">Supprimer</div>
				<button id="spinnerBtn" class="btn btn-primary hide" type="button">
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
				</button>
			</div>
		</div>
	</div>


	<!-- Required jquery and libraries -->
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

	<!-- cookie js -->
	<script src="js/jquery.cookie.js"></script>

	<!-- Swiper slider  -->
	<!-- <script src="vendor/swiper/js/swiper.min.js"></script> -->

	<!-- Masonry js -->
	<script src="vendor/masonry/masonry.pkgd.min.js"></script>

	<!-- Customized jquery file  -->
	<script src="js/main.js"></script>
	<script src="js/color-scheme-demo.js"></script>

	<!-- page level custom script -->
	<script>
		// NEW SCRIPT
		let G_Places;
		window.addEventListener('load', async () => {
			initSpecialCssRules();

			// Fetch all needed info to fill the page
			const userToken = localStorage['token'];
			if (!userToken) {
				console.warn('USER IS A VISITOR - NO DATA WILL BE SHOWN')
				document.querySelector('#boat_form')
					.querySelector('.card-body')
					.innerHTML = 'No data available for visitors';
				document.querySelector('#profil_form')
					.querySelector('.card-body')
					.innerHTML = 'No data available for visitors';
				document.querySelector('#preferences-container')
					.querySelector('.card-body')
					.innerHTML = '<div style="padding-left: 15px">No data available for visitors</div>';
				document.querySelector('#change-pwd-container')
					.querySelector('.card-body')
					.innerHTML = 'No data available for visitors';
				document.querySelector('#submit-btn')
					.style.display = 'none';
				return;
			}
			const userInfo = await getUserInfos(userToken);
			const boatInfo = await getBoatInfo(userInfo);
			if (boatInfo) {
				const places = await getPlacesFromHarbour(localStorage["harbour_id"]);
				G_Places = places; // to access the places out of the scope
				const pontons = await getPontonsFromHarbour(localStorage["harbour_id"]);

				let boatPlace;
				if (places) {
					for (const place of places) {
						if (place.id === boatInfo?.place_id) {
							boatPlace = place;
							break;
						}
					}
					let boatPonton;
					for (const ponton of pontons) {
						if (ponton.id === boatPlace?.pontonId) {
							boatPonton = ponton;
							break;
						}
					}
					// keep places for the selected ponton
					const placesByPonton = places?.filter(place => place?.pontonId === boatPonton?.id);
					populatePontonDropdown(pontons, boatPonton?.id);
					populatePlacesDropdown(placesByPonton, boatPlace?.id);
				}
				populateFormInitialInfos(userInfo, boatInfo);

				// add event listener
				document.querySelector('#ponton-select')
					.addEventListener('change', pontonDropdownOnChangeHandler);
			} else {
				populateFormInitialInfos(userInfo, undefined);
			}

		});


		const getUserInfos = async () => {
			const url = `/api/getuser`;
			const fetchBody = JSON.stringify({ userId: localStorage['user'] });
			const fetchOptions = {
				method: 'POST',
				body: fetchBody,
			};
			const response = await fetch(url, fetchOptions);
			if (!response.ok) {
				console.error(response);
				return;
			}
			const decoded = await response.json();
			const userInfo = decoded.data;
			return(userInfo);
		};

		const getBoatInfo = async (user) => {
			const url = `/api/get/userboats?user_id=${user.id}&harbour_id=${user.harbour_id}`;
			const fetchOptions = { method: 'GET' };
			const response = await fetch(url, fetchOptions);
			if (!response.ok) {
				console.error(response);
				return;
			}
			const decoded = await response.json();
			const boatInfo = decoded.data;
			if (boatInfo?.length > 0) {
				return (boatInfo[0]);
			}
			return (boatInfo);
		};

		const getPlacesFromHarbour = async (harbour_id) => {
			const url = `/api/places?harbour_id=${harbour_id}`;
			const response = await fetch(url);
			if (!response.ok) {
				console.error(response);
				return;
			}
			const decoded = await response.json();
			const places = decoded?.data || [];
			places?.sort((a, b) => (a.number < b.number) ? -1 : 1);
			return (places);
		};

		const getPontonsFromHarbour = async (harbour_id) => {
			const url = `/api/zones?harbour_id=${localStorage['harbour_id']}`;
			const response = await fetch(url, { method: 'GET' });
			if (!response.ok) {
				console.error(response);
				return;
			}
			const decoded = await response.json();
			const zones = decoded.data || [];
			const pontons = [];
			zones.map(zone => {
				if (zone.type === 'ponton') pontons.push(zone);
			});
			pontons.sort((a, b) => (a.name < b.name) ? -1 : 1);
			return (pontons)
		};

		const populateFormInitialInfos = (user, boat) => {
			document.getElementById("first_name").value = user.first_name || '-';
			document.getElementById("last_name").value = user.last_name || '-';
			document.getElementById("email").value = user.email || '-';
			document.getElementById("prefix").value = user.prefix || '-';
			document.getElementById("phone").value = user.phone || '-';

			if (boat) {
				document.getElementById("boat_id").value = boat.id;
				document.getElementById("name").value = boat.name || '-';
				document.getElementById("immatriculation").value = boat.immatriculation || '-';
				document.getElementById("longueur").value = boat.longueur || '-';
				document.getElementById("largeur").value = boat.largeur || '-';
				document.getElementById("tirant_eau").value = boat.tirant_eau || '-';
			} else {
				document.querySelector('#boat_form')
					.querySelector('.card-body')
					.innerHTML = 'Vous n\'avez pas enregistré de bateau';
			}
		}

		const populatePontonDropdown = (pontonsInfos = [], selectedPontonId) => {
			const pontonsSelectEl = document.querySelector('#ponton-select');
			pontonsSelectEl.innerHTML = '';
			if (!selectedPontonId) {
				pontonsSelectEl.innerHTML += `<option value='' id='' selected> - </option>`
			}
			pontonsInfos.map(ponton => {
				if (ponton.id === selectedPontonId) {
					pontonsSelectEl.innerHTML += `
							<option value='${ponton.id}' id='${ponton.id}' selected>${ponton.name}</option>
						`
				} else {
					pontonsSelectEl.innerHTML += `
							<option value='${ponton.id}' id='${ponton.id}'>${ponton.name}</option>
						`
				}
			});
		};

		const populatePlacesDropdown = (placesInfos = [], selectedPlaceId) => {
			const placesSelectEl = document.querySelector('#place-select');
			placesSelectEl.innerHTML = '';
			if (!selectedPlaceId) {
				placesSelectEl.innerHTML += `<option value='' id='' selected> - </option>`
			}
			placesInfos.map(place => {
				if (place.id === selectedPlaceId) {
					placesSelectEl.innerHTML += `
							<option value='${place.id}' id='${place.id}' selected>${place.number}</option>
						`
				} else {
					placesSelectEl.innerHTML += `
							<option value='${place.id}' id='${place.id}'>${place.number}</option>
						`
				}
			});
		};

		const pontonDropdownOnChangeHandler = (ev) => {
			const newPontonId = ev.target.value;
			const newPlacesByPonton = G_Places.filter(place => place.pontonId === newPontonId);
			populatePlacesDropdown(newPlacesByPonton, undefined);
		}


		function activateBoatForm() {
			document.getElementById("boat_form").hidden = false;
			document.getElementById("add_boat_button").hidden = true;
			document.getElementById("delboatbutton").hidden = true;
		}


		const initSpecialCssRules = () => {
			if (localStorage['entity_id'] == '4eqv44307K') {
				document.getElementById('validate_button')?.setAttribute("style", "background-color: #FB9101;");
			}
		};

		function disconnect() {
			localStorage.removeItem("harbour_id");
			localStorage.removeItem("harbourname");
			localStorage.removeItem("user");
			localStorage.removeItem("token");
			localStorage.removeItem('onesignal_userid');
			window.location.href = ("/?entity=" + localStorage['entity_id']);
		}

		function sendForm() {
			var form = document.getElementById("profil_form");
			var formData = new FormData(form);
			formData.append("token", localStorage["token"])

			fetch("/api/updateuser", { method: "post", body: formData }).then(response => response.json()).then(_data => {
				if (_data.success) {
					window.location.reload();
				} else {
					if (document.getElementById("error"))
						document.getElementById("updateError").removeChild(document.getElementById("error"));

					document.getElementById("updateError").insertAdjacentHTML("beforeend", '<div id="error" class="alert alert-danger">ERREUR : ' + _data.message + '</div>');
				}
			}).catch((error) => {
				console.error(error);
			});
		};

		function sendBoatForm() {
			var form = document.getElementById("boat_form");
			var formData = new FormData(form);
			formData.append("token", localStorage["token"])
			formData.append("harbour", localStorage["harbour_id"])

			fetch("/api/updateboat", { method: "post", body: formData }).then(response => response.json()).then(_data => {
				if (_data.success) {
					window.location.reload();
				} else {
					if (document.getElementById("errorBoat"))
						document.getElementById("updateBoatError").removeChild(document.getElementById("error"));

					document.getElementById("updateBoatError").insertAdjacentHTML("beforeend", '<div id="errorBoat" class="alert alert-danger">ERREUR : ' + _data.message + '</div>');
				}
			}).catch((error) => {
				console.error(error);
			});
		};

		function deleteBoatForm() {

			var form = document.getElementById("boat_form");
			var formData = new FormData(form);
			formData.append("token", localStorage["token"])
			fetch("/api/deleteBoat", { method: "post", body: formData }).then(response => response.json()).then(_data => {
				if (_data.success) {
					window.location.reload();
				} else {
					if (document.getElementById("errorBoat"))
						document.getElementById("updateBoatError").removeChild(document.getElementById("errorBoat"));

					document.getElementById("updateBoatError").insertAdjacentHTML("beforeend", '<div id="error" class="alert alert-danger">ERREUR : ' + _data.message + '</div>');
				}
			}).catch((error) => {
				console.error(error);
			});
		};

		const displayAccountDeletionModal = () => {
			const mainEl = document.querySelector('main');
			const deleteAccountModalEl = document.querySelector('#deleteAccountModal');
			if (!deleteAccountModalEl) {
				alert('Une erreur est survenue...')
				return;
			}
			mainEl.style.display = 'none';
			deleteAccountModalEl.classList.remove('hide');
		}
		const hideAccountDeletionModal = () => {
			const mainEl = document.querySelector('main');
			const deleteAccountModalEl = document.querySelector('#deleteAccountModal');
			if (!deleteAccountModalEl) {
				alert('Une erreur est survenue...')
				return;
			}
			deleteAccountModalEl.classList.add('hide');
			mainEl.style.display = 'block';
		}

		const deleteMyAccount = async () => {
			const deleteAccountModalEl = document.querySelector('#deleteAccountModal');
			const delBtnEl = deleteAccountModalEl.querySelector('#delBtn');
			const cancelBtnEl = deleteAccountModalEl.querySelector('#cancelBtn');
			const spinnerBtnEl = deleteAccountModalEl.querySelector('#spinnerBtn');

			delBtnEl.style.display = 'none';
			cancelBtnEl.style.display = 'none';
			spinnerBtnEl.classList.remove('hide');
			const userToken = localStorage['token'];
			if(!userToken) {
				alert('No token found');
			}
			const body = JSON.stringify({ token: userToken })
			try {
					const response = await fetch('/api/users/delete-my-account',
						{
							method: 'DELETE',
							headers: { "token": userToken },
						}
					);
					spinnerBtnEl.classList.add('hide');
					if (!response.ok) {
						throw new Error('ERROR');
					}
					const resp = await response.json();
					disconnect();
			} catch (error) {
				console.error('[ERROR]', error);
				alert('ERROR')
			}

		};

	</script>

	<style>
		@font-face {
			font-family: 'Poppins Regular';
			font-style: normal;
			font-weight: normal;
			src: local('Poppins Regular'), url('/library/Poppins-Regular.woff') format('woff');
		}

		* {
			font-family: 'Poppins Regular' !important;
		}

		body {
			font-family: 'Poppins Regular' !important;
		}

		#validate_button {
			margin: 10px 0;
		}

		#AccountDeletionCtn {
			align-items: center;
			display: flex;
			flex-direction: column;
			justify-content: center;
			margin: 10px 0;
			padding-top: 20px;
		}
		#AccountDeletionCtn #deleteBtn {
			background-color: #dc3545;
			color: white;
		}

		/* Modal */
		.myModal {
			align-items: center;
			backdrop-filter:blur(4px);
			background-color: rgba(154, 154, 154, 0.5);
			display: flex;
			height: 100%;
			justify-content: center;
			position: absolute;
			text-align: justify;
			width: 100%;
			z-index: 10;
		}
		.myModal.hide {
			display: none;
		}
		.cardModal {
			align-items: center;
			background-color: white;
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			height: fit-content;
			justify-content: center;
			padding: 15px;
			width: 90%;
		}
		
		.cardModal #modal-text {
			font-size: 10pt;
			margin-bottom: 15px;
			padding: 0 20px;
		}
		.cardModal #modal-btn-ctn {
			display: flex;
			height: fit-content;
			justify-content: space-evenly;
			width: 100%;
		}
		.cardModal #modal-btn-ctn div {
			align-items: center;
			border-radius: 20px;
			color: white;
			display: flex;
			justify-content: center;
			min-width: 30%;
			padding: 5px 20px;
		}
		.cardModal #modal-btn-ctn div:first-of-type {
			background-color: #033B8A;
		}
		.cardModal #modal-btn-ctn div:last-of-type {
			background-color: #dc3545;
		}
		.cardModal #modal-btn-ctn button.hide {
			display: none;
		}


	</style>
	{{element->footer_app.html}}

</body>
<!-- Mirrored from maxartkiller.com/website/Nauticspot/setting.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 31 Aug 2020 16:49:14 GMT -->

</html>