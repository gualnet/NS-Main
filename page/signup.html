<!doctype html>
<html lang="en" class="h-100">


{{element->header_app.html}}

<body class="d-flex flex-column h-100">
	<!-- screen loader -->
	{{element->loader.html}}

	<!-- Fixed navbar -->
	<!-- Begin page content -->
	<main class="flex-shrink-0">
		<div class="container"
			style="border-radius: 25px; width: 325px; background-color: #FFFFFFF1; margin-bottom: 100px; padding-top: 40px; padding-bottom: 40px">
			<div class="login-box">
				<p style="text-align: center; font-size: 22px; margin-bottom: 0rem;">Création de votre profil</p>
				<p style="text-align: center; font-size: 14px; color: #666">Complétez vos informations</p>
				<form id="signupForm" method="post">
					<div class="form-group floating-form-group">
						<input name="first_name" type="text" class="form-control floating-input" value="" required>
						<label class="floating-label" style="color: #446E7B">Nom</label>
					</div>
					<div class="form-group floating-form-group">
						<input name="last_name" type="text" class="form-control floating-input" value="" required>
						<label class="floating-label" style="color: #446E7B">Prénom</label>
					</div>
					<!-- <div class="row">
						<div class="col-3">
							<div class="form-group floating-form-group">
								<input name="prefix" type="text" class="form-control floating-input" value="+33" required>
								<label class="floating-label" style="color: #446E7B">Préfixe</label>
							</div>
						</div>
						<div class="col-9">
							<div class="form-group floating-form-group">
								<input name="phone" type="tel" class="form-control floating-input" value="" required>
								<label class="floating-label" style="color: #446E7B">Téléphone mobile</label>
							</div>
						</div>
					</div> -->
					<div class="form-group floating-form-group">
						<input name="email" type="email" class="form-control floating-input" value="" autofocus required>
						<label class="floating-label" style="color: #446E7B">Email</label>
					</div>
					<div class="form-group floating-form-group">
						<input id="passwordInput" name="password" type="password" class="form-control floating-input" required>
						<label class="floating-label" style="color: #446E7B">Mot de passe</label>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="passwordHideBtn" onchange="tooglePasswordVisibility()">
							<label class="form-check-label fs-1" for="flexCheckDefault">
								Voir le mot de passe
							</label>
						</div>
					</div>
					<div class="form-group floating-form-group">
						<input id="passwordCheckInput" name="password_confirm" type="password" class="form-control floating-input" required>
						<label class="floating-label" style="color: #446E7B">Confirmer mot de passe</label>
					</div>
					<!-- NOT DISPLAYED -->
					<div class="form-group floating-form-group" style="display: none;">
						<label class="text-muted" for="category-select" style="color: #446E7B">Quelle est votre catégorie:</label>
						<select name="category" class="form-control" id="category-select" style="color: #446E7B">
							<!--<option value="professional">Professionel</option>-->
							<option value="yachtsman" style="color: #446E7B">Plaisancier</option>
							<!--<option value="visitor">Visiteur</option>-->
						</select>
					</div>
					<!-- NOT DISPLAYED -->
					<div class="form-group floating-form-group" style="display: none;">
						<label class="text-muted" for="harbour_id" style="color: #446E7B" style="color: #446E7B">Votre port de
							plaisance:</label>
						<select name="harbour_id" class="form-control" id="harbourlist" style="color: #446E7B">
						</select>
					</div>
					<div class="form-group my-4 text-secondary">
						En cliquant sur le bouton ci-dessous, je reconnais avoir lu et accepté
						<a href="#" class="link hyperlink" id="cguLink" download="nauticspot-cgu.pdf">les conditions générales</a> de l'application
					</div>
				</form>
				<form method="post" id="boatform">
					<div class="form-group floating-form-group">
						<p class="text-muted" style="color: #446E7B">Etes-vous résident du port ?</p>
						<div class="row">
							<div class="col">
								<button id="yesButton" type="button" class="btn btn-secondary" style="width:100%;"
									onclick="showResidentInputs();">Oui</button>
							</div>
							<div class="col">
								<button id="noButton" type="button" class="btn btn-primary" style="width:100%;"
									onclick="hideResidentInputs();">Non</button>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<div class="d-none" id="residentInput">
									<div class="form-group floating-form-group">
										<input name="contract_number" type="text" class="form-control floating-input" required>
										<label class="floating-label" style="color: #446E7B">N° contrat (facultatif)</label>
									</div>
									<div class="form-group floating-form-group">
										<label class="text-muted" for="category-select" style="color: #446E7B">Ponton</label>
										<select name="ponton_id" class="form-control" id="ponton-select"></select>
									</div>
									<div class="form-group floating-form-group">
										<label class="text-muted" for="category-select" style="color: #446E7B">Numéro de place</label>
										<select name="place_id" class="form-control" id="place-select"></select>
									</div>
									<div class="form-group floating-form-group">
										<input name="name" type="text" class="form-control floating-input" id="boat-name" required>
										<label class="floating-label" style="color: #446E7B">Nom du bateau</label>
									</div >
									<div class="form-group floating-form-group">
										<input name="immatriculation" type="text" class="form-control floating-input" required>
										<label class="floating-label" style="color: #446E7B">Immatriculation</label>
									</div >
									<div class="form-group floating-form-group">
										<input name="longueur" type="number" class="form-control floating-input" required>
										<label class="floating-label" style="color: #446E7B">Longueur (en m)</label>
									</div >
									<div class="form-group floating-form-group">
										<input name="largeur" type="text" class="form-control floating-input" required>
										<label class="floating-label" style="color: #446E7B">Largeur (en m)</label>
									</div >
									<div class="form-group floating-form-group">
										<input name="tirant_eau" type="number" class="form-control floating-input" required>
										<label class="floating-label" style="color: #446E7B">Tirant d'eau (en m)</label>
									</div >
									<div>
										<input name="is_resident" value="1" hidden>
									</div >
								</div>
							</div>
						</div>
					</div>
				</form>

				<button id="validate_button" onclick="sendSignupForm();"
					class="btn btn-block btn-danger btn-lg">Valider</button><br>
				<div class="row">
					<div class="col text-center">
						<div id="addUserError"></div>
						<a href="/signin" class="link" style="color: #446E7B">Déjà un compte ? Cliquez ici.</a>
					</div>
				</div>
			</div>
		</div>
	</main>

	<style>
		body,
		main {
			background: url("/library/Nauticspot-profil-background.jpg") 1500px / 500% !important;
		}

		@font-face {
			font-family: 'Poppins Regular';
			font-style: normal;
			font-weight: normal;
			src: local('Poppins Regular'), url('/library/Poppins-Regular.woff') format('woff');
		}

		* {
			font-family: 'Poppins Regular';
		}

		body {
			background: url("../background2.png") #FFF fixed;
			font-family: 'Poppins Regular' !important;
		}

		.hyperlink {
			color: #068bf1;
			text-decoration: underline;
		}
	</style>

	<!-- Required jquery and libraries -->
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

	<!-- cookie js -->
	<script src="js/jquery.cookie.js"></script>

	<!-- Swiper slider  -->
	<!-- <script src="vendor/swiper/js/swiper.min.js"></script> -->

	<!-- Masonry js -->
	<script src="vendor/masonry/masonry.pkgd.min.js"></script>

	<!-- Customized jquery file  -->
	<script src="js/main.js"></script>
	<script src="js/color-scheme-demo.js"></script>

	<!-- page level custom script -->
	<script>
		let isResident = false;
		"use strict"
		$(window).on('load', function () {
			if (localStorage['entity_id'] == '4eqv44307K')
				document.getElementById('validate_button')?.setAttribute("style", "background-color: #FB9101;");

			var data = new FormData();
			data.append("token", localStorage["token"]);
			if (localStorage['token']) {
				fetch("/api/user/session", { method: "post", body: data }).then(response => response.json()).then(_data => {
					if (_data.success)
						window.location.href = ("/index");

				}).catch((error) => {
					console.error(error);
				})
			}

			fetch("/api/getharbours/" + localStorage['entity_id'], {
				method: "get"
			}).then(response => response.json()).then(_data => {
				var harbours = _data.data;
				for (var i = 0; i < harbours.length; i++) {
					if (harbours[i].id == localStorage['harbour_id'])
						document.getElementById("harbourlist").insertAdjacentHTML("beforeend", ('<option value="' + harbours[i].id + '" selected>' + harbours[i].name + '</option>'));
					else
						document.getElementById("harbourlist").insertAdjacentHTML("beforeend", ('<option value="' + harbours[i].id + '">' + harbours[i].name + '</option>'));
				}
			}).catch((error) => {
				console.error(error);
			});

			constructCguLink();
			getPonton();
		});

		document.querySelector('#ponton-select')
			.addEventListener('change', (ev) => {
				const selectedPontonId = ev.target.value;
				getPlaces(selectedPontonId)
			});

		const constructCguLink = () => {
			const harbour_id = localStorage['harbour_id'];
			const cguLinkEl = document.querySelector('#cguLink');
			cguLinkEl.href = `/library/cgu_${harbour_id}.pdf`;
		}

		function sendSignupForm() {
			var form = document.getElementById("signupForm");
			var formData = new FormData(form);

			if (isResident) {
				const boatNameEl = document.querySelector('#boat-name');
				const boatNameValue = boatNameEl?.value;
				if (boatNameValue?.length < 1) {
					document.getElementById("addUserError").insertAdjacentHTML("beforeend", '<div id="error" class="alert alert-danger">ERREUR : ' + 'Nom du bateau manquant' + '</div>');
					setTimeout(() => {
						document.getElementById("error").remove();
					}, 5000);
					return;
				}
			}
			fetch("/api/verify/mail/", {
				method: form.method,
				body: formData
			}).then(response => response.json()).then(_data => {
				if (_data.success) {
					fetch("/api/adduser", {
						method: form.method,
						body: formData,
					}).then(response => response.json()).then(_data => {
						if (_data.success) {
							var user = _data.data;
							//user created, now creating the boat if user have boat
							if (document.querySelector('#yesButton').classList.contains('btn-primary')) {
								form = document.getElementById("boatform");
								formData = new FormData(form);
								formData.append("user_id", user.id);
								formData.append("harbour_id", user.harbour_id);
								fetch("/api/addboat",
									{
										method: form.method,
										body: formData,
									}).then(response => response.json()).then(_data => {
										//localStorage["boat"] = _data.data.id;
										localStorage["user"] = user.id;
										localStorage["harbour_id"] = user.harbour_id;
										localStorage["token"] = user.token;
										fetch("/api/getharbour/" + localStorage["harbour_id"]).then(response => response.json()).then(_data => {
											localStorage["harbourname"] = _data.data.name;
											window.location.href = ("/index");
										}).catch((error) => {
											console.error(error);
										});
									}).catch((error) => {
										console.error('Error:', error);
									});
							} else {
								localStorage["user"] = user.id;
								localStorage["harbour_id"] = user.harbour_id;
								localStorage["token"] = user.token;

								fetch("/api/getharbour/" + localStorage["harbour_id"]).then(response => response.json()).then(_data => {
									localStorage["harbourname"] = _data.data.name;
									window.location.href = ("/index");
								}).catch((error) => {
									console.error(error);
								});
							}
						}
						else {
							if (document.getElementById("error"))
								document.getElementById("addUserError").removeChild(document.getElementById("error"));

							document.getElementById("addUserError").insertAdjacentHTML("beforeend", '<div id="error" class="alert alert-danger">ERREUR : ' + _data.message + '</div>');
						}
					}).catch((error) => {
						console.error('Error:', error);
					});


				} else {
					if (document.getElementById("error"))
						document.getElementById("addUserError").removeChild(document.getElementById("error"));

					document.getElementById("addUserError").insertAdjacentHTML("beforeend", '<div id="error" class="alert alert-danger">ERREUR : ' + _data.message + '</div>');
				}
			}).catch((error) => {
				console.error("error");
			})
		}

		const showResidentInputs = () => {
			isResident = true;
			const residentFormEl = document.querySelector('#residentInput');
			residentFormEl.classList.replace('d-none', 'd-block');
			document.getElementById('yesButton').classList.replace('btn-secondary', 'btn-primary');
			document.getElementById('noButton').classList.replace('btn-primary', 'btn-secondary');
		};

		const hideResidentInputs = () => {
			isResident = false;
			const residentFormEl = document.querySelector('#residentInput');
			residentFormEl.classList.replace('d-block', 'd-none');
			document.getElementById('yesButton').classList.replace('btn-primary', 'btn-secondary');
			document.getElementById('noButton').classList.replace('btn-secondary', 'btn-primary');
		};

		var dynamicSort = function (property) {
			var sortOrder = 1;
			if (property[0] === "-") {
				sortOrder = -1;
				property = property.substr(1);
			}
			return function (a, b) {
				/* next line works with strings and numbers,
				 * and you may want to customize it to your needs
				 */
				var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
				return result * sortOrder;
			}
		}

		function getPonton() {
			const harbour_id = localStorage['harbour_id'];
			const url = `/api/pontons?harbour_id=${harbour_id}`;
			fetch(url, { method: "GET" })
				.then(response => response.json())
				.then(_data => {
					const pontons = _data?.data?.sort(dynamicSort("name"));
					if (!pontons) {
							document.getElementById('place-select').innerHTML = '<option value="Not Attributed">Aucun</option>';
							return;
						}
						document.getElementById('ponton-select').innerHTML = '<option value="Not Attributed">Aucun</option>';
						document.getElementById('place-select').innerHTML = '<option value="Not Attributed">Aucun</option>';
					for (var i = 0; i < pontons.length; i++) {
						if (pontons[i].name != "")
							document.getElementById('ponton-select').innerHTML += '<option value="' + pontons[i].id + '" >' + pontons[i].name + '</option>';
					}
				}).catch((e) => console.error(e));
		};

		function getPlaces(pontonId) {
			const harbour_id = localStorage['harbour_id'];
			const url = `/api/placesbyponton?harbour_id=${harbour_id}&ponton_id=${pontonId}`;
			fetch(url, { method: "GET" })
				.then(response => response.json())
				.then(_data => {
					if (_data.data) {
						var places = _data?.data?.sort(dynamicSort("number"));
						if (!places) {
							document.getElementById('place-select').innerHTML = '<option value="Not Attributed">Aucun</option>';
							return;
						}
						document.getElementById('place-select').innerHTML = "";
						for (var i = 0; i < places.length; i++) {
							document.getElementById('place-select').innerHTML += '<option value="' + places[i].id + '" >' + places[i].number + '</option>';
						}
					} else {
						document.getElementById('place-select').innerHTML = '<option value="Not Attributed">Aucun</option>';
					}
				}).catch((e) => console.error(e));
		}
	
		
		const tooglePasswordVisibility = () => {
				passwordHideBtn
				const pwdVisibilityBtnEl = document.querySelector('#passwordHideBtn');
				const passwordInputEl = document.querySelector('#passwordInput');
				const passwordCheckInputEl = document.querySelector('#passwordCheckInput');
				if (!pwdVisibilityBtnEl || !passwordInputEl || !passwordCheckInputEl) {
					console.warn('ERROR');
					return;
				};

				if (pwdVisibilityBtnEl.checked) {
					passwordInputEl.type = 'text';
					passwordCheckInputEl.type = 'text';
				} else {
					passwordInputEl.type = 'password';
					passwordCheckInputEl.type = 'password';
				}
			};


	</script>
	{{element->footer_app.html}}
</body>
</html>