<!doctype html>
<html lang="en" class="h-100">

{{element->header_app.html}}

<body class="body-scroll d-flex flex-column h-100 menu-overlay">
	<!-- screen loader -->
	{{element->loader.html}}

	<!-- Begin page content -->
	<main class="flex-shrink-0">
			<!-- Fixed navbar -->
			{{element->navheader.html}}
			<!-- page content start -->

			<div class="container" id="events_container">
				<div class="sub_container" id="incomingEventsCtn">
					<h5 class="title">Evenements à venir</h5>
					<div class="content"></div>
				</div>
				<div class="sub_container" id="pastEventsCtn">
					<h5 class="title">Evenements passés</h5>
					<div class="content"></div>
				</div>
			</div>
	</main>
	<div class="container py-3">
		{{element->navbar.html}}
	</div>


	<script>

		window.addEventListener('load', async () => {

			const events = await fetchEvents();
			displayEventList(events);

		});

		const fetchEvents = async () => {
			try {
				const url = `/api/events/${localStorage['harbour_id']}`;
				const resp = await fetch(url, { method: 'GET' });
				console.log('FETCHED EVENTS', resp);
				const respJson = await resp.json();
				console.log('respJson', respJson);
				const events = respJson.data;
				console.log('EVENTS', events);
				return(events);
			} catch (error) {
				console.error('[ERROR] Une erreur est survenue lors de la recuperation des evenements');
				return([]);
			}
		};

		const displayEventList = (events = []) => {
			const sortedEvents = events.sort((a, b) => a.date_end < b.date_end ? 1 : -1);
			const incomingEvents = [];
			const pastEvents = [];
			const refTimestamp = new Date(new Date().toDateString()).getTime(); // timestamp of today

			const monthNum = new Date().getMonth();
			const pastMonthNum = monthNum === 0 ? 11 : monthNum - 1;
			const oneMonthAgoTimestamp = new Date(new Date(new Date().setMonth(pastMonthNum)).toDateString()).getTime();
			sortedEvents.map(event => {
				if (event.date_end <= refTimestamp && event.date_end > oneMonthAgoTimestamp) { // passedEvent of last month
					let htmlEventRow = eventRow
						.replace("__ID__", event.id)
						.replace("__IMG__", event.img)
						.replace("__D_END__", new Date(event.date_end).toDateString())
						.replace("__TITLE__", event.title)
						.replace("__CONTENT__", event.description);
					pastEvents.push(htmlEventRow);
				} else if (event.date_end > refTimestamp) { // futur event
					let htmlEventRow = eventRow
						.replace("__ID__", event.id)
						.replace("__IMG__", event.img)
						.replace("__D_END__", new Date(event.date_end).toDateString())
						.replace("__TITLE__", event.title)
						.replace("__CONTENT__", event.description);
					incomingEvents.push(htmlEventRow);
				}
			});

			const pastEventsCtnEl = document.querySelector("#pastEventsCtn");
			const pastEventsContentEl = pastEventsCtnEl.querySelector(".content");
			const incomingEventsCtnEl = document.querySelector("#incomingEventsCtn");
			const incomingEventsContentEl = incomingEventsCtnEl.querySelector(".content");

			if (pastEvents.length > 0 && incomingEvents.length > 0) {
				// half half
				pastEventsCtnEl.classList.add('half');
				incomingEventsCtnEl.classList.add('half');
			} else if (pastEvents.length === 0 && incomingEvents.length > 0) {
				pastEventsCtnEl.classList.add('hide');
				incomingEventsCtnEl.classList.add('full');
			} else if (pastEvents.length > 0 && incomingEvents.length === 0) {
				pastEventsCtnEl.classList.add('full');
				incomingEventsCtnEl.classList.add('hide');
			} else {
				pastEventsCtnEl.classList.add('hide');
				incomingEventsCtnEl.classList.add('half');
			}

			pastEventsContentEl.insertAdjacentHTML("beforeend", pastEvents.join(' '));
			incomingEventsContentEl.insertAdjacentHTML("beforeend", incomingEvents.join(' '));
		};



		const eventRow = '<div class="row">'
			+ '<div class="col">'
			+ '<div style="width:100%;" class="card product-card-large mb-3" onclick="window.location.href = (\'event?id=__ID__\');">'
			+ '<div class="card-body p-0">'
			+ '<div class="product-image-large">'
			+ '<div class="background">'
			+ '<img style="width:100%;height:auto;" src="__IMG__" alt="">'
			+ '</div>'
			+ '</div>'
			+ '</div>'
			+ '<div class="card-footer">'
			+ '<div class="row">'
			+ '<div class="col">'
			+ '<h6 style="font-size: 13px;" ><strong>__D_END__</strong></h6>'
			+ '<h6 style="font-size: 13px;" ><strong>__TITLE__</strong></h6>'
			+ '</div>'
			+ '</div>'
			+ '<div class="row">'
			+ '<div class="col">'
			+ '<div class="small text-muted">__CONTENT__</div>'
			+ '</div>'
			+ '</div>'
			+ '</div>'
			+ '</div>'
			+ '</div>'
			+ '</div>';

	</script>

	<style>
		.container {
			display: flex;
			flex-direction: column;
			height: calc(100vh - 60px - 56px);
		}
		.sub_container {
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}
		.sub_container.half {
			min-height: 50%;
		}
		.sub_container.full {
			min-height: 50%;
		}
		.sub_container.hide {
			display: none;
		}
		.sub_container > .title {
			border-bottom: 1px solid rgba(0, 0, 0, .2);
			padding-left: 10px;
			justify-content: center;
		}
		.sub_container > .content {
			overflow-x: hidden;
			overflow-y: scroll;
		}
	</style>

    <!-- Required jquery and libraries -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- cookie js -->
    <script src="js/jquery.cookie.js"></script>

    <!-- Swiper slider  js-->
    <script src="vendor/swiper/js/swiper.min.js"></script>

    <!-- Masonry js -->
    <script src="vendor/masonry/masonry.pkgd.min.js"></script>

    <!-- nouislider js -->
    <script src="vendor/nouislider/nouislider.min.js"></script>

    <!-- Customized jquery file  -->
    <script src="js/main.js"></script>
    <script src="js/color-scheme-demo.js"></script>

    <!-- page level custom script -->
    <script>
        "use strict"
        $(window).on('load', function () {
            /* carousel */
            var swiper = new Swiper('.swiper-products', {
                slidesPerView: 'auto',
                spaceBetween: 0,
                pagination: 'false'
            });

        });
    </script>
</body>
{{element->footer_app.html}}
</html>
